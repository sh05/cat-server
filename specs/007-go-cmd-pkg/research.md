# 研究ドキュメント: Go標準ディレクトリ構造リファクタリング

**日付**: 2025-09-20
**対象**: 007-go-cmd-pkg機能の技術アプローチ研究

## 研究概要

Go言語のベストプラクティスに従ったディレクトリ構造への完全なリファクタリングのための技術研究。Domain Driven Design (DDD)、Clean Architecture、Onion Architectureの原則を適用し、既存機能を完全に維持しながら移行する方法を検討。

## 研究項目と決定

### 1. Go標準ディレクトリ構造の調査

**決定**: cmd/pkg構造 + internal パッケージの採用

**根拠**:
- `cmd/`: アプリケーションのエントリーポイント（main関数）を配置する Go標準パターン
- `pkg/`: 外部パッケージから利用可能な公開ライブラリコードを配置
- `internal/`: 外部パッケージからアクセス不可な内部実装を配置（Go言語の機能）
- Go公式プロジェクトレイアウト標準準拠
- Go modules機能との高い親和性

**検討した代替案**:
- 単一 `src/` ディレクトリ（現在の構造）: スケーラビリティに課題
- Flat構造: 依存関係管理の複雑化

### 2. アーキテクチャパターンの選択

**決定**: Clean Architecture + Domain Driven Design の軽量実装

**根拠**:
- cat-serverのシンプルなドメイン（ファイル操作）に適合
- 依存関係の方向性制御（内側から外側への依存のみ）
- テスタビリティの向上
- 将来の機能拡張への対応

**検討した代替案**:
- 純粋なMVCパターン: 小規模アプリには適用可能だが拡張性に課題
- ヘキサゴナルアーキテクチャ: 過度に複雑（憲法の簡素性原則に反する）
- レイヤードアーキテクチャ: 循環依存リスクが高い

### 3. パッケージ分割戦略

**決定**: ドメイン中心 + レイヤー分離のハイブリッド

**根拠**:
- `domain/`: ビジネスロジックの中核（entities, valueobjects, repositories interface）
- `application/`: ユースケース層（usecases, services）
- `infrastructure/`: 技術的実装（filesystem, http, logging）
- `interfaces/`: 外部インターフェース（http handlers, cli）

**検討した代替案**:
- 機能別分割: cat-serverの機能が限定的なため不適切
- 純粋なレイヤー分割: DDDの利点を活用できない

### 4. 移行戦略

**決定**: Strangler Fig パターンによる段階的移行

**根拠**:
- 既存機能の完全な維持を保証
- 各コンポーネントを個別に移行可能
- テストによる安全性確保
- ダウンタイムゼロでの移行

**移行順序**:
1. Domain層の定義（interface, entities）
2. Infrastructure層の実装
3. Application層の実装
4. Interfaces層の実装
5. cmd/の作成とwiring
6. 旧src/の削除

**検討した代替案**:
- Big Bang移行: リスクが高すぎる
- 並行実行: リソース効率が悪い

### 5. 依存関係注入戦略

**決定**: 手動DI（constructor injection）

**根拠**:
- Go標準アプローチ
- フレームワーク依存なし（憲法の依存関係最小化原則）
- 可読性とデバッグ容易性
- cat-serverの規模に適切

**検討した代替案**:
- DIフレームワーク（wire, dig等）: 過度な複雑性
- Service Locatorパターン: アンチパターン

### 6. テスト戦略の維持

**決定**: 既存テスト構造の保持 + 新しいユニットテストの追加

**根拠**:
- 既存の高品質なテストスイートを活用
- リファクタリング安全性の確保
- 段階的なテスト改善

**新規テスト要件**:
- Domain層のユニットテスト（ビジネスロジック）
- Application層のユニットテスト（ユースケース）
- Interface層のモック使用テスト

### 7. インポートパス戦略

**決定**: github.com/sh05/cat-server 基準の相対パス

**新しいパッケージパス例**:
```go
import (
    "github.com/sh05/cat-server/pkg/domain/entities"
    "github.com/sh05/cat-server/pkg/application/usecases"
    "github.com/sh05/cat-server/pkg/infrastructure/filesystem"
)
```

**根拠**:
- Go modules標準
- 明確な依存関係表現
- IDE支援の活用

## 技術的制約と考慮事項

### パフォーマンス影響
- **結論**: 影響なし
- 理由: 主にコード整理でありランタイム性能への影響なし

### 後方互換性
- **結論**: Docker環境、CLI引数、API互換性を完全維持
- 確認方法: 既存テストスイートの全成功

### 開発効率
- **結論**: 短期的な作業増加、長期的な効率向上
- リファクタリング期間: 推定1-2日（実装+テスト）

## 実装ガイドライン

### コード移行原則
1. **No Feature Changes**: 機能追加は一切行わない
2. **Test First**: 移行前に該当テストを確認
3. **Incremental**: 一つのレイヤーずつ移行
4. **Validation**: 各ステップで品質ゲート実行

### リスク軽減策
- 各移行ステップでのテスト実行
- git branchでの段階的コミット
- Docker動作確認を継続実行

## 次フェーズへの準備

すべての要明確化事項が解決され、技術アプローチが確定しました。フェーズ1（設計とコントラクト）の実行準備が完了しています。

---
*研究完了日: 2025-09-20*