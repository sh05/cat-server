# データモデル: Docker Image作成機能

**フェーズ1出力** | **日付**: 2025-09-20

## エンティティ定義

### 1. Dockerイメージ
**概要**: cat-serverアプリケーションを実行可能な形でパッケージ化したコンテナイメージ

**構造**:
- **ベースイメージ**: alpine:latest (約5MB)
- **アプリケーションバイナリ**: /app/cat-server (静的リンク)
- **実行ユーザー**: app (非root, UID/GID 自動割り当て)
- **公開ポート**: 8080
- **作業ディレクトリ**: /app
- **エントリーポイント**: ./cat-server

**検証ルール**:
- イメージサイズ < 50MB
- 非rootユーザーでの実行
- Healthcheckの応答時間 < 3秒
- セキュリティスキャンでの重大な脆弱性なし

### 2. ビルドステージ
**概要**: マルチステージビルドにおける段階的な処理単位

#### ステージ1: Builder
- **ベースイメージ**: golang:alpine
- **作業ディレクトリ**: /build
- **環境変数**:
  - CGO_ENABLED=0
  - GOOS=linux
  - GOARCH=amd64
- **処理内容**:
  - go.mod, go.sum のコピー
  - go mod download による依存関係解決
  - ソースコードのコピー
  - go build による静的バイナリ作成

**検証ルール**:
- バイナリが静的リンクされている
- go vet, go test がパスする
- ビルド時間 < 60秒 (初回)

#### ステージ2: Runtime
- **ベースイメージ**: alpine:latest
- **必要パッケージ**: wget (Healthcheck用)
- **ユーザー設定**: app ユーザーの作成
- **処理内容**:
  - パッケージのインストール
  - 非rootユーザーの作成
  - バイナリのコピー（Builder stage から）
  - 実行権限の設定

**検証ルール**:
- パッケージ最小限の構成
- 非rootユーザーでの実行可能性
- 必要ポートへのアクセス可能性

### 3. 実行環境設定
**概要**: コンテナ実行時の環境とリソース設定

**設定項目**:
- **ポート**: 8080 (HTTP API)
- **環境変数**:
  - PORT=8080 (デフォルト)
  - GIN_MODE=release (本番モード)
- **リソース制限**:
  - メモリ: 64MB (推奨)
  - CPU: 0.1 (推奨)
- **ヘルスチェック**:
  - 間隔: 30秒
  - タイムアウト: 3秒
  - 開始期間: 5秒
  - 再試行: 3回

**検証ルール**:
- 起動時間 < 2秒
- Healthcheck エンドポイント応答
- メモリ使用量 < 32MB (実行時)
- 指定されたディレクトリからのファイル提供

## 状態遷移

### ビルドプロセス状態
```
[ソースコード] → [Builder Stage] → [静的バイナリ] → [Runtime Stage] → [実行可能イメージ]
      ↓               ↓                 ↓               ↓                ↓
   [コピー]        [コンパイル]      [最適化]        [統合]         [テスト可能]
```

### 実行プロセス状態
```
[イメージ] → [コンテナ作成] → [起動] → [ヘルスチェック] → [サービス準備完了]
     ↓            ↓           ↓           ↓                ↓
 [ロード]     [環境設定]   [プロセス]    [HTTP確認]      [API応答]
```

## データ関係

### 依存関係
- **Dockerfile** ← **ビルドステージ定義**
- **ビルドステージ** ← **実行環境設定**
- **Dockerイメージ** ← **すべてのエンティティ**

### 検証関係
- **イメージサイズ** ← **ベースイメージ + バイナリサイズ + 依存パッケージ**
- **セキュリティ** ← **ユーザー権限 + パッケージ脆弱性**
- **パフォーマンス** ← **静的リンク + 最適化フラグ + ライブラリサイズ**

## 制約と制限

### システム制約
- Docker Engine 20.10+ 必須
- Linux/AMD64 アーキテクチャ対応
- 最小メモリ要件: 128MB (ホスト)
- 最小ディスク容量: 100MB (イメージ + ログ)

### 開発制約
- Go 1.20+ による開発
- 静的リンクビルド必須（CGO_ENABLED=0）
- Alpine Linux互換性の確保
- POSIX準拠のシェルコマンド使用

### 運用制約
- ポート8080の利用可能性
- コンテナランタイム権限
- ネットワークアクセス（Healthcheck用）
- ファイルシステム読み取り権限（サーブ対象ディレクトリ）