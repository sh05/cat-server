# 実装計画: ファイル内容取得エンドポイント (/cat/<filename>)

**ブランチ**: `005-cat-filename-ls` | **日付**: 2025-09-20 | **仕様書**: [spec.md](./spec.md)
**入力**: `/specs/005-cat-filename-ls/spec.md` からの機能仕様
**ユーザー指示**: 既存のサーバーを利用して実装してください。

## 実行フロー (/plan コマンド範囲)
```
1. 入力パスから機能仕様をロード
   → 完了: spec.md から /cat/{filename} エンドポイント仕様を読み込み
2. 技術コンテキストを記入 (要明確化をスキャン)
   → プロジェクトタイプ: single (CLI アプリケーション + HTTP サーバー)
   → 既存サーバー拡張として実装
3. 憲法文書の内容に基づいて憲法チェックセクションを記入
   → 完了: Go言語、テスト要件、品質ゲートを確認
4. 以下の憲法チェックセクションを評価
   → 違反なし: cat-server の機能拡張として適切
   → 進捗追跡を更新: 初期憲法チェック合格
5. フェーズ0を実行 → research.md
   → HTTP ルーティング実装パターン、ファイル読み込み最適化を研究
6. フェーズ1を実行 → contracts, data-model.md, quickstart.md, CLAUDE.md更新
   → REST API仕様、JSON レスポンス構造、統合テストを設計
7. 憲法チェックセクションを再評価
   → 設計レビュー実行
8. フェーズ2を計画 → タスク生成アプローチを説明
9. 停止 - /tasks コマンドの準備完了
```

**重要**: /planコマンドはステップ8で停止します。フェーズ2-4は他のコマンドで実行されます:
- フェーズ2: /tasks コマンドが tasks.md を作成
- フェーズ3-4: 実装実行 (手動またはツール経由)

## 概要
API利用者がHTTP GETリクエストで特定ディレクトリの特定ファイル内容を取得できる `/cat/{filename}` エンドポイントを既存のHTTPサーバーに追加。パスパラメータでファイル名を指定し、既存の`-dir`フラグで指定されたディレクトリから読み取り。Go標準ライブラリを使用し、既存の`/ls`エンドポイントと同様の構造で実装。

## 技術コンテキスト
**言語/バージョン**: Go (最新安定版)
**主要依存関係**: Go標準ライブラリ (net/http, os, path/filepath, encoding/json)
**ストレージ**: ローカルファイルシステム
**テスト**: Go組み込みテストフレームワーク (go test)
**対象プラットフォーム**: Unix/Linux/macOS/Windows (Go標準対応)
**プロジェクトタイプ**: single (CLI + HTTPサーバー統合)
**パフォーマンス目標**: 10MB以下のファイルで応答時間 <200ms
**制約**: メモリ使用量最小化、大きなファイル時の安全な処理、セキュリティ対策
**規模/範囲**: 既存cat-serverへの機能追加、新規エンドポイント1つ
**実装詳細**: 既存のサーバー構造を利用して実装（handlers/, services/ ディレクトリ活用）

## 憲法チェック
*GATE: フェーズ0研究前に合格必須。フェーズ1設計後に再チェック。*

**言語ポリシー**:
- [x] 内部ドキュメント (仕様書、計画、タスク) は日本語で記述
- [x] 外部ドキュメント (README, APIドキュメント) は英語で記述
- [x] コードコメントとコミットは英語で記述

**Go標準**:
- [x] Go プログラミング言語のみを使用
- [x] Go コミュニティのベストプラクティスとイディオムに従う
- [x] 外部依存関係を最小化

**テスト要件**:
- [x] すべての関数/メソッドに対するユニットテストを計画
- [x] Go の組み込みテストフレームワークを使用
- [x] TDD アプローチ: 実装前にテスト

**品質ゲート**:
- [x] go vet, go fmt, go test, go build 検証を計画に含める
- [x] 品質ゲートのCI/CD強制を計画

**簡素性**:
- [x] 機能が cat-server のコア目的と一致
- [x] 不要な複雑性と抽象化を避ける

## プロジェクト構造

### ドキュメント (この機能)
```
specs/005-cat-filename-ls/
├── plan.md              # このファイル (/plan コマンド出力)
├── research.md          # フェーズ0出力 (/plan コマンド)
├── data-model.md        # フェーズ1出力 (/plan コマンド)
├── quickstart.md        # フェーズ1出力 (/plan コマンド)
├── contracts/           # フェーズ1出力 (/plan コマンド)
└── tasks.md             # フェーズ2出力 (/tasks コマンド - /plan では作成されない)
```

### ソースコード (リポジトリルート)
```
# 既存構造を拡張
src/
├── server/             # 既存: HTTPサーバー実装
├── handlers/           # 拡張: cat.go を追加
├── services/           # 既存: directory.go を活用
└── main.go            # 既存: 新しいルートを登録

tests/
├── unit/              # 拡張: cat_handler_test.go を追加
├── integration/       # 拡張: cat_endpoint_test.go を追加
├── contract/          # 拡張: OpenAPI仕様テスト
└── performance/       # 拡張: cat_performance_test.go を追加

specs/                 # 機能仕様とコントラクト
```

**構造決定**: 既存のsingle プロジェクト構造を拡張、新規ディレクトリは作成しない

## フェーズ0: 概要と研究

1. **技術コンテキストから研究項目を抽出**:
   - HTTPパスパラメータの最適な実装方法
   - ファイル読み込みのセキュリティ対策
   - 大きなファイルの効率的な処理
   - 既存サーバー構造への統合方法

2. **研究要項**:
   - Go net/httpでのパスパラメータ処理ベストプラクティス
   - ファイル読み込み時のパストラバーサル攻撃対策
   - メモリ効率的なファイル読み込み実装
   - 既存DirectoryServiceの再利用方法

3. **結果を統合** して `research.md` に記録:
   - 決定: 選択された技術アプローチ
   - 根拠: セキュリティ、パフォーマンス、保守性の観点
   - 検討した代替案: 評価した他のアプローチ

**出力**: すべての技術的不明点が解決された research.md

## フェーズ1: 設計とコントラクト
*前提条件: research.md 完了*

1. **機能仕様からエンティティを抽出** → `data-model.md`:
   - ファイルパス (パスパラメータ + ディレクトリ設定)
   - ファイル内容 (テキストデータ)
   - APIレスポンス構造
   - エラーレスポンス構造

2. **機能要件からAPIコントラクトを生成**:
   - `GET /cat/{filename}` エンドポイント仕様
   - 成功レスポンス (200) スキーマ
   - エラーレスポンス (404, 403, 400, 500) スキーマ
   - OpenAPIスキーマを `/contracts/` に出力

3. **コントラクトからコントラクトテストを生成**:
   - cat_endpoint_contract_test.go
   - レスポンススキーマ検証
   - エラーケーステスト
   - テストは失敗する必要がある (まだ実装なし)

4. **ユーザーストーリーからテストシナリオを抽出**:
   - 基本ファイル読み取りシナリオ
   - カスタムディレクトリシナリオ
   - エラーケースシナリオ
   - クイックスタートテスト = ストーリー検証ステップ

5. **CLAUDE.md を増分的に更新**:
   - `/cat/{filename}` エンドポイントの使用例を追加
   - テストコマンドを追加
   - 既存の内容を保持、新機能のみ追加

**出力**: data-model.md, /contracts/*, 失敗するテスト, quickstart.md, CLAUDE.md更新

## フェーズ2: タスク計画アプローチ
*このセクションは /tasks コマンドが行うことを説明 - /plan では実行しない*

**タスク生成戦略**:
- `.specify/templates/tasks-template.md` をベースとしてロード
- フェーズ1設計ドキュメントからタスクを生成
- コントラクトテスト → 失敗するテスト作成タスク [P]
- エンティティ → データ構造定義タスク [P]
- ハンドラー実装 → cat.go作成タスク
- サービス統合 → DirectoryService拡張タスク
- ルート登録 → server.go更新タスク

**順序戦略**:
- TDD順序: テスト → 実装
- 依存関係順序: サービス → ハンドラー → ルート登録
- 並列実行 (独立ファイル) に [P] をマーク

**推定出力**: tasks.md 内の15-20の番号付き順序タスク

**重要**: このフェーズは /tasks コマンドで実行され、/plan では実行されません

## フェーズ3以降: 今後の実装
*これらのフェーズは /plan コマンドの範囲外です*

**フェーズ3**: タスク実行 (/tasks コマンドが tasks.md を作成)
**フェーズ4**: 実装 (憲法原則に従って tasks.md を実行)
**フェーズ5**: 検証 (テスト実行、quickstart.md 実行、パフォーマンス検証)

## 複雑性追跡
*憲法チェックに正当化が必要な違反がある場合のみ記入*

| 違反 | 必要な理由 | 却下されたより簡単な代替案とその理由 |
|-----------|------------|-------------------------------------|
| (なし) | | |

## 進捗追跡
*このチェックリストは実行フロー中に更新される*

**フェーズステータス**:
- [x] フェーズ0: 研究完了 (/plan コマンド)
- [x] フェーズ1: 設計完了 (/plan コマンド)
- [x] フェーズ2: タスク計画完了 (/plan コマンド - アプローチ説明のみ)
- [ ] フェーズ3: タスク生成 (/tasks コマンド)
- [ ] フェーズ4: 実装完了
- [ ] フェーズ5: 検証合格

**ゲートステータス**:
- [x] 初期憲法チェック: 合格
- [x] 設計後憲法チェック: 合格
- [x] すべての要明確化を解決
- [x] 複雑性逸脱を文書化

---
*憲法 v1.0.0 ベース - `.specify/memory/constitution.md` を参照*