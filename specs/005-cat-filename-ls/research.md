# 技術研究: /cat/<filename> エンドポイント実装

**研究日**: 2025-09-20
**対象機能**: ファイル内容取得エンドポイント

## 研究項目

### 1. HTTPパスパラメータ処理方法

**調査内容**: Go net/httpでのパスパラメータ実装ベストプラクティス

**決定**: `http.ServeMux` のパターンマッチング機能を使用
- パターン: `GET /cat/{filename}`
- Go 1.22以降の新しいマルチプレクサ機能を活用
- `r.PathValue("filename")` でパラメータ取得

**根拠**:
- Go標準ライブラリのみで実装可能
- 既存の `/ls` エンドポイント実装と一貫性
- 外部ライブラリ依存を避けるという憲法原則に準拠
- シンプルで理解しやすい

**検討した代替案**:
- gorilla/mux: 外部依存となり憲法違反
- 手動URLパース: エラーが発生しやすく複雑

### 2. ファイル読み込みセキュリティ対策

**調査内容**: パストラバーサル攻撃対策とファイルアクセス制御

**決定**: 多層防御アプローチ
1. `filepath.Clean()` でパス正規化
2. `filepath.Join()` で安全なパス結合
3. `strings.Contains(cleanPath, "..")` でトラバーサル検出
4. 結果パスが指定ディレクトリ配下かチェック
5. ファイル存在・読み取り権限の事前確認

**根拠**:
- セキュリティベストプラクティスに準拠
- 既存DirectoryServiceでの実装パターンと一貫性
- Go標準ライブラリで実現可能

**検討した代替案**:
- `filepath.Rel()` のみ使用: 不十分なセキュリティ
- サンドボックス実装: 過度に複雑

### 3. 大きなファイルの効率的処理

**調査内容**: メモリ効率とパフォーマンス最適化

**決定**: ファイルサイズ制限付きの一括読み込み
- 制限: 10MB以下のファイルのみサポート
- `os.Stat()` で事前サイズチェック
- `os.ReadFile()` で一括読み込み
- 大きなファイルは413エラーで拒否

**根拠**:
- cat-serverの用途（設定ファイル、ログファイルの確認）に適している
- メモリ使用量を予測可能に制限
- シンプルな実装で十分
- レスポンス時間を200ms以下に維持可能

**検討した代替案**:
- ストリーミング実装: cat-serverの用途に対して過度に複雑
- 無制限読み込み: メモリ安全性に問題

### 4. 既存サーバー構造への統合

**調査内容**: 既存のDirectoryService活用とサーバー拡張方法

**決定**: 最小限の変更で既存構造を活用
- `DirectoryService` のディレクトリパス取得機能を再利用
- 新しい `CatHandler` を `handlers/cat.go` に作成
- `server/server.go` に新しいルート登録
- エラーハンドリングパターンを既存 `ListHandler` と統一

**根拠**:
- コード重複を避ける
- 既存パターンとの一貫性
- 保守性の向上
- 最小限の変更で最大の効果

**検討した代替案**:
- 完全独立実装: コード重複が発生
- ListHandlerに統合: 単一責任原則に違反

## ファイル形式とエンコーディング対応

**調査内容**: テキストファイル以外の対応方針

**決定**: テキストファイル専用として実装
- UTF-8エンコーディングを前提
- バイナリファイルは415エラーで拒否
- テキストファイル判定: `utf8.Valid()` でチェック

**根拠**:
- cat-serverの「catコマンド代替」という目的に整合
- セキュリティリスクを最小化
- 実装の複雑性を避ける

**検討した代替案**:
- Base64エンコーディング: catコマンドの動作と非一致
- バイナリ対応: セキュリティリスクと複雑性増加

## レスポンス形式設計

**調査内容**: JSONレスポンス構造の最適化

**決定**: シンプルで拡張可能な構造
```json
{
  "content": "ファイル内容",
  "filename": "example.txt",
  "size": 1234,
  "directory": "./files/",
  "generated_at": "2025-09-20T10:00:00Z"
}
```

**根拠**:
- ユーザー仕様「特に制約なし」に対応
- 既存 `/ls` エンドポイントとの一貫性
- 将来の機能拡張に対応可能

**検討した代替案**:
- 最小限構造（contentのみ）: メタデータが不足
- 過度に詳細な構造: 複雑性が増加

## 技術的制約と前提

1. **Go 1.22以上**: パスパラメータ機能に必要
2. **ファイルサイズ制限**: 10MB以下
3. **テキストファイル専用**: UTF-8エンコーディング
4. **既存DirectoryService依存**: ディレクトリ設定の一貫性
5. **パフォーマンス目標**: <200ms応答時間

## 実装優先順位

1. **最高優先**: セキュリティ対策（パストラバーサル防止）
2. **高優先**: 基本機能（ファイル読み込み・レスポンス生成）
3. **中優先**: エラーハンドリング（404, 403, 413, 415）
4. **低優先**: パフォーマンス最適化
5. **最低優先**: 将来拡張への準備

## 結論

研究により、既存のcat-server構造を最大限活用しながら、セキュリティを重視したシンプルな実装方針が確定した。Go標準ライブラリのみを使用し、憲法原則に完全準拠できることを確認した。